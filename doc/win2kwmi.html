<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="author" content="Jake Brutlag">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>Installing Cricket on Win2K to Monitor WMI Counters</title>
<author>
</head>

<body>

<h1>Installing Cricket on Win2K to Monitor WMI Counters</h1>
<p>Draft 3: April 6, 2001&nbsp;<o:p>
</o:p>
</p>
<p>Windows 2000 includes Windows Management Instrumentation (WMI), an
implementation of the Web-based Enterprise Management (WBEM) industry standard.
Hardware, operating system, and application (such as SQL Server, and IIS)
performance data counters are available through WMI.</p>
<p>Cricket is an open-source software tool originally designed for network
monitoring and trend analysis on UNIX platforms. The source data monitored by
Cricket is not restricted to network data and it has been successfully applied
to monitor hosts and applications at WebTV. Cricket is
written in Perl, and its underlying data storage technology, RRDtool, is
available for Win32 platforms. Cricket includes a CGI component for monitoring
access from any web browser.</p>
<p>This document describes the process of installing Cricket on Windows 2000,
running Cricket with Internet Information Server (IIS), and using Cricket to
collect data from WMI counters. It assumes some familiarity with Windows 2000,
IIS, WMI, Perl Modules, and Cricket.</p>
<p>You may wish to review John Zola's document <a href="http://cricket.sourceforge.net/support/FAQ/nt_cricket.html">Installing
Cricket on NT 4.0</a>. He discusses some of the details omitted from this
document (such as compiling RRDs).</p>
<h2>The Materials List</h2>
<p>Deploying Cricket on Windows 2000 to monitor WMI relies on a number of Perl
packages and some external software. Fortunately, these packages and software
are all available and compatible with Windows 2000. The following is a list of
the components along with their provider.</p>
<p>Perl Packages:</p>
<ul style="margin-top:0in" type="disc">
  <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list .5in"><a href="http://velocity.activestate.com/code/">ActiveState
    Package Repository</a> or <a href="http://www.cpan.org">CPAN</a></li>
  <ul style="margin-top:0in" type="circle">
    <li class="MsoNormal" style="mso-list:l3 level2 lfo7;tab-stops:list 1.0in">Digest
      (MD5)</li>
    <li class="MsoNormal" style="mso-list:l3 level2 lfo7;tab-stops:list 1.0in">DB_File</li>
    <li class="MsoNormal" style="mso-list:l3 level2 lfo7;tab-stops:list 1.0in">TimeDate</li>
  </ul>
  <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list .5in"><a href="http://www.rrdtool.org">www.rrdtool.org</a></li>
  <ul style="margin-top:0in" type="circle">
    <li class="MsoNormal" style="mso-list:l3 level2 lfo7;tab-stops:list 1.0in">RRDs</li>
  </ul>
  <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list .5in"><a href="http://www.switch.ch/misc/leinen/snmp/perl">www.switch.ch/misc/leinen/snmp/perl</a></li>
  <ul style="margin-top:0in" type="circle">
    <li class="MsoNormal" style="mso-list:l3 level2 lfo7;tab-stops:list 1.0in">SNMP_Session</li>
  </ul>
</ul>
<p>Binaries:</p>
<ul style="margin-top:0in" type="disc">
  <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list .5in">Berkeley
    DB (<a href="http://www.sleepycat.com">www.sleepycat.com</a>)</li>
  <li class="MsoNormal" style="mso-list:l3 level1 lfo7;tab-stops:list .5in">ActivePerl
    (<a href="http://www.activestate.com">www.activestate.com</a>)</li>
</ul>
<h2>Installation Instructions:</h2>
<p>Before you begin, install Windows 2000 Server with IIS. You will need the
Microsoft Visual C++. These
instructions assume the default configuration for IIS.</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">1.
Create a monitoring account in the domain. Give this account
administrator access on the monitoring machine (the machine that will run
Cricket). On the remote hosts to be monitored, set the proper permissions for
the monitoring account (this will require the assistance of your domain
administrator).</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">a.
On each remote host, the following WMI permissions need to granted to the
monitoring account for the namespace that includes the counters you wish to
monitor: Execute Methods, Provider Write, Enable Account, and Remote Enable
(Windows 2000 sets the first three to allow by default for Everyone). This can
be done through scripting, or the WMI Control management snap-in (run
wmimgmt.msc on a Windows 2000 host).</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">b.
WMI permissions are not sufficient alone to access some system
objects/properties you may wish to monitor if these objects/properties are
managed through the host or domain security policy. On the remote Windows 2000
computer, use the Local Security Policy control panel applet (under
Administrative Tools). For example, you may need to change the settings on
Profile System Performance under Local Policies\User Rights Assignment.</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">c.
You can use the WMI program, wbemtest.exe (found in the %system32%\wbem
directory) to confirm permissions are set correctly. If step (a) is not
completed for a host, you will receive an access denied message. If step (b) is
not completed, WMI queries will seem to work, but NULL or zero values will be
returned (this can be hard to determine because some fields may legitimately be
NULL or zero).</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">d.
If you have security difficulties, one option is to make the monitoring
account an administrator on each remote host it will monitor. But the “right
thing to do” is for the monitoring account to be a regular domain user will
just the additional permissions it needs for read only access to the WMI
counters and objects to be monitored.</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">2.
Login to the monitoring machine using the monitoring account.</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">3.
Install Perl from the ActiveState distribution. Notes on the ActiveState
installer: installing PerlScript and&nbsp; Perl for ISAPI is not required.
Enable the options registering Perl with the Web Server and adding the Perl bin
directory to your path.</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">4.
Install Berkeley DB. Following the instructions included with the
distribution. Your goal is compile the DLL libdb31.dll. Once compiled, make
certain this DLL is on your path..</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">5.
Install Cricket. You may find John Zola's <a href="http://cricket.sourceforge.net/support/FAQ/nt_cricket.html">Installing
Cricket on NT 4.0</a> helpful. The remainder of the document refers to the installation
directory as &lt;install dir&gt;. The cricket subdirectory of &lt;install
dir&gt; contains the Cricket source code.</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">6.
Install the additional Perl packages. For Perl extensions (a package that
includes a compiled DLL), the extension build must be compatible with the build
of ActiveState installed. Currently, ActiveState builds 5xx are Perl 5.005 and
ActiveState builds 6xx are Perl 5.6. The packages DB_File, Digest-MD5, and
TimeDate are available at the ActiveState Perl Package Archive for both 5xx and
6xx ActiveState builds. They can be installed via the utility <a href="http://velocity.activestate.com/docs/ActivePerl/faq/ActivePerl-faq2.html">ppm</a>.
You will need to compile the source for the RRDs package after
installing ActiveState. The source of RRDs is available from <a href="http://www.rrdtool.org/">www.rrdtool.org</a>.
After compilation, manually install this packages to the site/lib subtree of
your Perl installation.
SNMP_Session package does not need to be compiled because it does rely on an
auxiliary DLL. After you download the archive, extract the *.pm files and
install them in your site/lib subtree.</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">7.
Configure IIS. Start the Internet Services Manager.</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">a.
Create a virtual directory called crickethome. Set the local directory to
&lt;install dir&gt;.</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">b.
Register *.cgi files to be processed by the Perl executable. Right-click
properties on the crickethome virtual directory. Disable read, write, and
directory browsing. Set Execute Permissions to “None”. Click the
Configuration button. Look at the settings for the *.pl extension. Then create a
new Application mapping for *.cgi and enter the same information.</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">c.
Enable permissions on the cricket subdirectory of &lt;install dir&gt;.
Again, right-click properties. Grant read and set Execute Permissions to
“Scripts and Executables”.</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">d.
Stop and restart the Default Web Site.</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">e.
Update the environment variable settings in grapher.cgi and mini-graph.cgi.
This is because the HOME environment variable is not available running within
IIS.
&lt;install dir&gt;/cricket and gCacheDir to &lt;install dir&gt;/cricket-cache.
Modify the $ENV{‘HOME’} setting in the fixHome() subroutine to &lt;install
dir&gt; (the comments in the grapher.cgi source code refer to this as the
‘brute force’ method). Use forward slashes in pathnames. Do the same with
mini-graph.cgi. In mini-graph.cgi you may also need to replace 'perl' with the
complete path to the Perl executable (c:/perl/bin/perl) on the exec() call mini-graph.cgi
uses to invoke grapher.cgi in the doGraph() subroutine.</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">8.
Create a scheduled task to run the Cricket script collect-subtrees (this
the a wrapper script which invokes the Cricket collector and performs logging).</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">a.
Set the HOME environment variable for the monitoring account to
&lt;install dir&gt; (this can be done via a tab on the control panel System
applet). This HOME variable need only be set on the monitoring machine for the
monitoring account.</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">b.
Click on Add Scheduled Task under Control Panel\Scheduled Tasks. Click
through the wizard, choose a dummy application, give it the name “Cricket
Collector”, and choose a dummy run schedule. Enter the username and password
the monitoring account. Enable the “Open advanced properties” check box and
click Finish.</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">c.
Now configure the real task. Enter a command line similar to the
following (substituting paths on your system as appropriate):</p>
<p style="margin-left:.75in">c:\Perl\bin\perl &lt;install dir&gt;/cricket/collect-subtrees</p>
<p style="margin-left:.75in">Set the “Start in” field to &lt;install dir&gt;</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">d.
Select the Schedule tab. Schedule the task daily; then click the Advanced
button. Don’t choose an End Date. Enable and complete the Repeat task section.
Set the task to run every 5 minutes (or other interval, this should match the <a href="reference.html#target">rrd-poll-interval</a>
you are using). Set the duration to 23 hours and 55 minutes (or 24 hours –
whatever interval you are using).</p>
<p style="margin-left:1.0in;text-indent:-.25in;mso-list:l4 level2 lfo5;
tab-stops:list 1.0in">e.
Back on the Task tab, uncheck the Enabled checkbox.</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">9. Create and compile a Cricket config tree. Configure the
subtree-sets file (in
&lt;install dir&gt;\cricket). Refer to <a href="reference.html">Cricket
documentation</a> and the next section on this document, <a href="#wbemodbc">Monitoring
WMI Counters</a>. After successful compilation, you may choose to run the
collector manually to check for any errors.</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">10. Enable the scheduled task you created in step (8).</p>
<p style="margin-left:.25in;text-indent:-.25in;mso-list:l4 level1 lfo5;
tab-stops:list .25in">11. After a few minutes, check log files in &lt;install dir&gt;/cricket-logs to verify
everything is running okay. Test the grapher on the monitoring machine with the
URL: <a href="http://localhost/crickethome/cricket/grapher.cgi">http://localhost/crickethome/cricket/grapher.cgi</a></p>
<h2><a name="wbemodbc">Monitoring WMI Counters</a></h2>
<p>&nbsp;<o:p>
</o:p>
Polling WMI counters is facilitated through the fetch module, wbem.pm. This
diagram illustrates the layers of the data collection mechanism:</p>

<p><img border="0" src="win2kw1.gif" width="363" height="261"></p>

<p>As described in the Cricket documentation, each data collection mechanism has
a scheme, which describes a mapping between the ds-source tag of the data source
dictionary entry and the list of arguments passed to the fetch module. For WBEM, the scheme is:</p>
<pre>
wbem:host:namespace:class:field:predicate
</pre>
<p class="MsoNormal">The arguments host and namespace are used to establish a
connection to either the local or a remote machine. The arguments class, field,
and predicate are use to construct a WQL query.<o:p>
</o:p>
</p>
<p class="MsoNormal">No username and password are specified for remote queries.
The DCOM layer automatically substitutes the username and password of the
monitoring account when a connection is established to a remote machine.<o:p>
</o:p>
</p>
<p class="MsoNormal">Host is a Win2K host name. Host should be blank or
unspecified for the local machine.</p>
<p class="MsoNormal">Namespace refers to the WMI namespace to be queried. Most
of the interesting WMI classes are under Root\CIMV2. Backslashes in the
namespace specification must be escaped.</p>
<p class="MsoNormal"><span style="font-size: 12.0pt; mso-bidi-font-size: 13.0pt; mso-fareast-font-family: Times New Roman; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA; mso-bidi-font-weight: bold">WQL
is a language very similar to SQL for querying WMI classes. A WMI class can be
thought of as a table, with one or more records, or instances. The attributes of
the class are the table fields. Conceptually, the class, field, and predicate
for a WBEM data source generate the query:</span></p>
<pre>Select field from class where predicate</pre>
<p class="MsoNormal">If the class of interest has only once instance, then the
predicate argument can be omitted. If the class has multiple instances, you
should specific a predicate to restrict the result to a single instance.
Although Cricket supports multiple instances for SNMP data sources, this is not
the case for WBEM data sources. Each data source must be mapped to exactly one
WMI instance; in other words, each WQL query must be a singleton select.<o:p>
</o:p>
</p>
<p class="MsoNormal">Similar to the Cricket SNMP fetch modules, wbem.pm
consolidates multiple requests to the same remote host and the same WMI class
(table) as long as the data sources are within the same target (RRD file).
Separate targets requiring remote connections to the same host will result in
separate connections.<o:p>
</o:p>
</p>
<span style="font-size: 12.0pt; mso-bidi-font-size: 13.0pt; mso-fareast-font-family: Times New Roman; mso-ansi-language: EN-US; mso-fareast-language: EN-US; mso-bidi-language: AR-SA; mso-bidi-font-weight: bold">For
example, suppose you wish to monitor both the ReadOperationCount and
WriteOperationCount for some Win32_Process on the same machine. Here are the two
ds-source entries:</span>
<pre>
wbem:host:Root\\CIMV2:Win32_Process:ReadOperationCount:Name='process.exe'
wbem:host:Root\\CIMV2:Win32_Process:WriteOperationCount:Name='process.exe'
</pre>
<p>If these data source are in the same target, wbem.pm will establish a
single connection to host as username and issue the WQL query:</p>
<pre>Select &quot;ReadOperationCount&quot;, &quot;WriteOperationCount&quot; from &quot;Win32_Process&quot; where Name = 'process.exe'</pre>
<p>If you are uncertain as to what can be monitored via WMI, you can use the WMI
Object Browser included with the WMI SDK. You can test the semantics and syntax
of WQL queries through wbemtest.exe, a utility included on all Win2K systems.</p>
<h3>Acknowledgments</h3>
<p>Thanks to Brian Gann, Cary Yee, Adam Meltzer, Jeff Allen, and John Zola.</p>
<p>Questions or comments: contact <a href="mailto:%20jakeb@users.sourceforge.net">Jake
Brutlag</a>.</p>

</body>

</html>
